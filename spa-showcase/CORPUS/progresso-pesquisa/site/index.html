<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Pesquisa Bibliogr√°fica</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* HEADER */
        header {
            background: white;
            border-bottom: 2px solid var(--gray-200);
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .backup-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .unsaved-alert {
            background: var(--warning);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .unsaved-alert.show {
            display: block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: var(--primary-dark);
        }

        button.secondary {
            background: var(--gray-700);
        }

        button.secondary:hover {
            background: var(--gray-900);
        }

        button.success {
            background: var(--success);
        }

        /* DASHBOARD */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
        }

        .metric-label {
            font-size: 14px;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--gray-200);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 12px;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }

        /* HEATMAP */
        .heatmap {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            margin-bottom: 30px;
        }

        .heatmap h2 {
            font-size: 18px;
            margin-bottom: 16px;
            color: var(--gray-900);
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
        }

        .heatmap-cell {
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            border: 2px solid transparent;
        }

        .heatmap-cell.empty {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .heatmap-cell.partial {
            background: #fef3c7;
            color: #92400e;
            border-color: var(--warning);
        }

        .heatmap-cell.complete {
            background: #d1fae5;
            color: #065f46;
            border-color: var(--success);
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 5px;
            border-bottom: 2px solid var(--gray-200);
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-700);
            transition: all 0.2s;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* PESQUISAS */
        .module-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--gray-200);
            margin-bottom: 20px;
        }

        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .module-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .prompt-item {
            border-left: 3px solid var(--gray-300);
            padding: 15px;
            margin-bottom: 15px;
            background: var(--gray-50);
            border-radius: 4px;
        }

        .prompt-item.executed {
            border-left-color: var(--success);
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .prompt-code {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: var(--primary);
        }

        .prompt-title {
            font-size: 15px;
            font-weight: 500;
            margin: 5px 0;
        }

        .engine-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 5px;
        }

        .engine-gemini {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .engine-perplexity {
            background: #e3f2fd;
            color: #1565c0;
        }

        .engine-consensus {
            background: #f3e5f5;
            color: #6a1b9a;
        }

        .executions-list {
            margin-top: 15px;
            border-top: 1px solid var(--gray-200);
            padding-top: 15px;
        }

        .execution-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--gray-200);
            margin-bottom: 10px;
        }

        .execution-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .execution-date {
            font-size: 13px;
            color: var(--gray-700);
        }

        .links-section {
            margin-top: 15px;
        }

        .link-item {
            background: var(--gray-50);
            padding: 12px;
            border-radius: 4px;
            border-left: 3px solid var(--gray-300);
            margin-bottom: 8px;
        }

        .link-item.verified {
            border-left-color: var(--primary);
        }

        .link-item.relevant {
            border-left-color: var(--success);
        }

        .link-item.irrelevant {
            border-left-color: var(--gray-300);
            opacity: 0.6;
        }

        .link-url {
            font-size: 13px;
            color: var(--primary);
            word-break: break-all;
            margin-bottom: 5px;
        }

        .link-controls {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .link-controls button {
            padding: 5px 12px;
            font-size: 12px;
        }

        /* FORMUL√ÅRIOS */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
        }

        input[type="text"],
        input[type="url"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            color: var(--gray-700);
            font-size: 24px;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        /* UTILIT√ÅRIOS */
        .hidden {
            display: none !important;
        }

        .text-muted {
            color: var(--gray-700);
            font-size: 14px;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <h1>üî¨ Gerenciador de Pesquisa Bibliogr√°fica</h1>
                <div class="backup-controls">
                    <span class="unsaved-alert" id="unsavedAlert">‚ö†Ô∏è 50+ altera√ß√µes sem backup</span>
                    <button onclick="exportBackup()">üíæ Exportar Backup</button>
                    <button onclick="openImportModal()" class="secondary">üìÇ Importar Backup</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- DASHBOARD -->
        <div class="dashboard" id="dashboard">
            <div class="metric-card">
                <div class="metric-label">Progresso Geral</div>
                <div class="metric-value" id="progressValue">0/80</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Status de Anota√ß√µes</div>
                <div class="metric-value" id="annotationsValue">0/0</div>
                <p class="text-muted mt-10">Links anotados vs verificados</p>
            </div>

            <div class="metric-card">
                <div class="metric-label">Distribui√ß√£o por Motor</div>
                <div style="font-size: 14px; margin-top: 10px;">
                    <div><span class="engine-badge engine-gemini">Gemini</span> <strong id="geminiCount">0</strong></div>
                    <div><span class="engine-badge engine-perplexity">Perplexity</span> <strong id="perplexityCount">0</strong></div>
                    <div><span class="engine-badge engine-consensus">Consensus</span> <strong id="consensusCount">0</strong></div>
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Links Pendentes</div>
                <div class="metric-value" id="pendingLinksValue">0</div>
                <p class="text-muted mt-10">Aguardando verifica√ß√£o</p>
            </div>
        </div>

        <!-- MAPA DE CALOR -->
        <div class="heatmap">
            <h2>Mapa de Calor por M√≥dulo</h2>
            <div class="heatmap-grid" id="heatmapGrid"></div>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('pesquisas')">Pesquisas</button>
            <button class="tab" onclick="switchTab('zotero')">Integra√ß√£o Zotero</button>
        </div>

        <!-- TAB: PESQUISAS -->
        <div class="tab-content active" id="pesquisasTab">
            <button onclick="openAddExecutionModal()" style="margin-bottom: 20px;">‚ûï Registrar Nova Execu√ß√£o</button>
            <div id="modulesContainer"></div>
        </div>

        <!-- TAB: ZOTERO -->
        <div class="tab-content" id="zoteroTab">
            <div class="module-section">
                <h2>Exporta√ß√£o para Zotero</h2>
                <p class="text-muted mb-10">Selecione links marcados como "relevante" para exportar em formato BibTeX</p>
                <div class="button-group">
                    <button onclick="exportBibTeX()" class="success">üìÑ Exportar BibTeX</button>
                    <button onclick="showZoteroChecklist()">‚úÖ Ver Checklist de Importa√ß√£o</button>
                </div>
                <div id="zoteroChecklist" class="mt-10"></div>
            </div>
        </div>
    </div>

    <!-- MODAL: ADICIONAR EXECU√á√ÉO -->
    <div class="modal" id="addExecutionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Registrar Nova Execu√ß√£o</h3>
                <button class="close-modal" onclick="closeModal('addExecutionModal')">√ó</button>
            </div>

            <form onsubmit="addExecution(event)">
                <div class="form-group">
                    <label>M√≥dulo</label>
                    <select id="moduleSelect" required onchange="updatePromptSelect()">
                        <option value="">Selecione um m√≥dulo...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Prompt</label>
                    <select id="promptSelect" required>
                        <option value="">Selecione um prompt...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Motor de Busca</label>
                    <select id="engineSelect" required>
                        <option value="gemini">Gemini Deep Research</option>
                        <option value="perplexity">Perplexity Academic</option>
                        <option value="consensus">Consensus</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Notas Gerais</label>
                    <textarea id="executionNotes" placeholder="Insights principais, qualidade dos resultados, quest√µes que surgiram..."></textarea>
                </div>

                <div class="form-group">
                    <label>Links Encontrados (um por linha)</label>
                    <textarea id="linksInput" placeholder="https://exemplo.com/artigo1
https://exemplo.com/artigo2
..."></textarea>
                </div>

                <div class="button-group">
                    <button type="submit">Salvar Execu√ß√£o</button>
                    <button type="button" onclick="closeModal('addExecutionModal')" class="secondary">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: IMPORTAR BACKUP -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Importar Backup</h3>
                <button class="close-modal" onclick="closeModal('importModal')">√ó</button>
            </div>

            <div class="form-group">
                <label>Selecione o arquivo JSON de backup</label>
                <input type="file" id="importFile" accept=".json">
            </div>

            <p class="text-muted">‚ö†Ô∏è Isso substituir√° todos os dados atuais. Exporte um backup antes se necess√°rio.</p>

            <div class="button-group">
                <button onclick="importBackup()">Importar</button>
                <button onclick="closeModal('importModal')" class="secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== ESTRUTURA DE DADOS ====================
        
        // Estrutura da bateria de prompts (extra√≠da do documento)
        const PROMPTS_STRUCTURE = {
            "1": {
                name: "Lacunas Bibliogr√°ficas Fundamentais",
                prompts: {
                    "1.1a": { title: "Mapeamento Energ√©tico", engine: "gemini" },
                    "1.1b": { title: "Geografia de Data Centers", engine: "gemini" },
                    "1.1c": { title: "Custo Computacional Espec√≠fico", engine: "perplexity" },
                    "1.1d": { title: "Impacto Ambiental Comparativo", engine: "perplexity" },
                    "1.1e": { title: "Valida√ß√£o Emp√≠rica", engine: "consensus" },
                    "1.2a": { title: "Panorama Latino-Americano", engine: "gemini" },
                    "1.2b": { title: "Desigualdade Norte-Sul em IA", engine: "gemini" },
                    "1.2c": { title: "Modelos em Portugu√™s/Espanhol", engine: "perplexity" },
                    "1.2d": { title: "Investimento Regional Comparativo", engine: "perplexity" },
                    "1.2e": { title: "Vi√©s Lingu√≠stico", engine: "consensus" },
                    "1.3a": { title: "Capitalismo de Vigil√¢ncia Aplicado a IA", engine: "gemini" },
                    "1.3b": { title: "Autenticidade na Era Digital", engine: "gemini" },
                    "1.3c": { title: "Economia de Startups de Detec√ß√£o", engine: "perplexity" },
                    "1.3d": { title: "Vigil√¢ncia Educacional", engine: "perplexity" },
                    "1.3e": { title: "Impacto Psicol√≥gico da Vigil√¢ncia", engine: "consensus" }
                }
            },
            "2": {
                name: "Detectores de IA - Dimens√£o T√©cnica e Cr√≠tica",
                prompts: {
                    "2.1a": { title: "Estado da Arte em Detec√ß√£o", engine: "gemini" },
                    "2.1b": { title: "Taxonomia de Limita√ß√µes", engine: "gemini" },
                    "2.1c": { title: "Estudos de Acur√°cia", engine: "perplexity" },
                    "2.1d": { title: "Corrida Armamentista", engine: "perplexity" },
                    "2.1e": { title: "Efic√°cia Comparativa", engine: "consensus" },
                    "2.2a": { title: "Vi√©s Sistem√°tico", engine: "gemini" },
                    "2.2b": { title: "Casos Documentados de Dano", engine: "gemini" },
                    "2.2c": { title: "Estudos de Vi√©s Lingu√≠stico", engine: "perplexity" },
                    "2.2d": { title: "Impacto em Escritores Profissionais", engine: "perplexity" },
                    "2.2e": { title: "Discrimina√ß√£o Algor√≠tmica", engine: "consensus" },
                    "2.3a": { title: "Economia Pol√≠tica de Detectores", engine: "gemini" },
                    "2.3b": { title: "Pol√≠ticas Universit√°rias Comparadas", engine: "gemini" },
                    "2.3c": { title: "Investimento em Startups de Detec√ß√£o", engine: "perplexity" },
                    "2.3d": { title: "Regula√ß√£o Governamental", engine: "perplexity" },
                    "2.3e": { title: "Efic√°cia de Pol√≠ticas Institucionais", engine: "consensus" }
                }
            },
            "3": {
                name: "Metodologia e Reflexividade",
                prompts: {
                    "3.1a": { title: "Uso de IA na Pesquisa Acad√™mica", engine: "gemini" },
                    "3.1b": { title: "Reflexividade Metodol√≥gica em Estudos de IA", engine: "gemini" },
                    "3.1c": { title: "Diretrizes de Journals sobre IA", engine: "perplexity" },
                    "3.1d": { title: "Casos de Retrata√ß√£o", engine: "perplexity" },
                    "3.1e": { title: "Impacto na Produtividade Acad√™mica", engine: "consensus" },
                    "3.2a": { title: "Versionamento como M√©todo", engine: "gemini" },
                    "3.2b": { title: "Limites da Auditabilidade", engine: "gemini" },
                    "3.2c": { title: "Ferramentas de Documenta√ß√£o de Processo", engine: "perplexity" },
                    "3.2d": { title: "Benef√≠cios de Open Science", engine: "consensus" },
                    "3.3a": { title: "Taxonomias de Uso de IA", engine: "gemini" },
                    "3.3b": { title: "Ferramentas de Atribui√ß√£o de Autoria", engine: "perplexity" },
                    "3.3c": { title: "Percep√ß√£o de Autoria", engine: "consensus" }
                }
            },
            "4": {
                name: "Filosofia e Teoria Cr√≠tica",
                prompts: {
                    "4.1a": { title: "Parrhesia Contempor√¢nea", engine: "gemini" },
                    "4.1b": { title: "Subjetiva√ß√£o e Tecnologias do Eu", engine: "gemini" },
                    "4.1c": { title: "Foucault e Tecnologia Educacional", engine: "perplexity" },
                    "4.1d": { title: "Impacto de Vigil√¢ncia em Express√£o", engine: "consensus" },
                    "4.2a": { title: "Conhecimento Situado na Era da IA", engine: "gemini" },
                    "4.2b": { title: "Ciborgues Contempor√¢neos", engine: "gemini" },
                    "4.2c": { title: "Epistemologia Feminista e IA", engine: "perplexity" },
                    "4.3a": { title: "Simulacro na Arte Gerada por IA", engine: "gemini" },
                    "4.3b": { title: "Pol√™micas Art√≠sticas com IA", engine: "perplexity" },
                    "4.3c": { title: "Percep√ß√£o de Autenticidade", engine: "consensus" }
                }
            },
            "5": {
                name: "Contexto Brasileiro e Latino-Americano",
                prompts: {
                    "5.1a": { title: "Pol√≠ticas Nacionais de IA Brasil", engine: "gemini" },
                    "5.1b": { title: "Universidades Brasileiras e IA", engine: "gemini" },
                    "5.1c": { title: "Ag√™ncias de Fomento", engine: "perplexity" },
                    "5.1d": { title: "SciELO e Peri√≥dicos Nacionais", engine: "perplexity" },
                    "5.2a": { title: "Pesquisa Latino-Americana sobre IA", engine: "gemini" },
                    "5.2b": { title: "Autores Latino-Americanos Relevantes", engine: "perplexity" }
                }
            },
            "6": {
                name: "Prompts Transversais e Integrativos",
                prompts: {
                    "6.1a": { title: "Mapa Completo do Campo", engine: "gemini" },
                    "6.1b": { title: "Controv√©rsias Mapeadas", engine: "gemini" },
                    "6.2a": { title: "Fact-Checking de Claims", engine: "perplexity" },
                    "6.2b": { title: "Valida√ß√£o de Hip√≥tese Central", engine: "consensus" },
                    "6.3a": { title: "Desenvolvimentos Recentes", engine: "gemini" },
                    "6.3b": { title: "Breaking News", engine: "perplexity" }
                }
            },
            "7": {
                name: "Prepara√ß√£o de Qualifica√ß√£o",
                prompts: {
                    "7.1a": { title: "Obje√ß√µes Prov√°veis", engine: "gemini" },
                    "7.1b": { title: "Lacunas Metodol√≥gicas", engine: "gemini" },
                    "7.2a": { title: "Trabalhos Seminais Faltantes", engine: "perplexity" },
                    "7.2b": { title: "Autores Essenciais", engine: "perplexity" }
                }
            }
        };

        // Estado da aplica√ß√£o (carregado do localStorage)
        let appState = {
            executions: [], // Array de { moduleId, promptId, engine, date, notes, links: [{url, title, status, notes, zoteroImported}] }
            unsavedChanges: 0
        };

        // ==================== INICIALIZA√á√ÉO ====================
        
        function init() {
            loadState();
            populateModuleSelect();
            renderDashboard();
            renderHeatmap();
            renderModules();
        }

        function loadState() {
            const saved = localStorage.getItem('pesquisaBibliografica');
            if (saved) {
                appState = JSON.parse(saved);
            }
        }

        function saveState() {
            localStorage.setItem('pesquisaBibliografica', JSON.stringify(appState));
            appState.unsavedChanges++;
            
            if (appState.unsavedChanges >= 50) {
                document.getElementById('unsavedAlert').classList.add('show');
            }
            
            renderDashboard();
            renderHeatmap();
            renderModules();
        }

        // ==================== DASHBOARD ====================
        
        function renderDashboard() {
            const totalPrompts = Object.values(PROMPTS_STRUCTURE).reduce((sum, module) => sum + Object.keys(module.prompts).length, 0);
            const executedPrompts = new Set(appState.executions.map(e => `${e.moduleId}-${e.promptId}`)).size;
            const progressPercent = Math.round((executedPrompts / totalPrompts) * 100);

            document.getElementById('progressValue').textContent = `${executedPrompts}/${totalPrompts}`;
            document.getElementById('progressFill').style.width = `${progressPercent}%`;

            // Contagem de links
            const allLinks = appState.executions.flatMap(e => e.links || []);
            const verifiedLinks = allLinks.filter(l => l.status !== 'unverified');
            const annotatedLinks = allLinks.filter(l => l.notes && l.notes.trim() !== '');
            const pendingLinks = allLinks.filter(l => l.status === 'unverified');

            document.getElementById('annotationsValue').textContent = `${annotatedLinks.length}/${verifiedLinks.length}`;
            document.getElementById('pendingLinksValue').textContent = pendingLinks.length;

            // Contagem por motor
            const gemini = appState.executions.filter(e => e.engine === 'gemini').length;
            const perplexity = appState.executions.filter(e => e.engine === 'perplexity').length;
            const consensus = appState.executions.filter(e => e.engine === 'consensus').length;

            document.getElementById('geminiCount').textContent = gemini;
            document.getElementById('perplexityCount').textContent = perplexity;
            document.getElementById('consensusCount').textContent = consensus;
        }

        // ==================== HEATMAP ====================
        
        function renderHeatmap() {
            const container = document.getElementById('heatmapGrid');
            container.innerHTML = '';

            Object.keys(PROMPTS_STRUCTURE).forEach(moduleId => {
                const module = PROMPTS_STRUCTURE[moduleId];
                const promptIds = Object.keys(module.prompts);
                const executedPrompts = appState.executions.filter(e => e.moduleId === moduleId).map(e => e.promptId);
                const uniqueExecuted = new Set(executedPrompts).size;
                
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                
                if (uniqueExecuted === 0) {
                    cell.classList.add('empty');
                } else if (uniqueExecuted < promptIds.length) {
                    cell.classList.add('partial');
                } else {
                    cell.classList.add('complete');
                }
                
                cell.innerHTML = `
                    <div style="font-weight: 600;">M√≥dulo ${moduleId}</div>
                    <div style="font-size: 11px; margin-top: 5px;">${uniqueExecuted}/${promptIds.length} prompts</div>
                `;
                
                container.appendChild(cell);
            });
        }

        // ==================== M√ìDULOS E PROMPTS ====================
        
        function renderModules() {
            const container = document.getElementById('modulesContainer');
            container.innerHTML = '';

            Object.keys(PROMPTS_STRUCTURE).forEach(moduleId => {
                const module = PROMPTS_STRUCTURE[moduleId];
                const moduleDiv = document.createElement('div');
                moduleDiv.className = 'module-section';

                let promptsHTML = '';
                Object.keys(module.prompts).forEach(promptId => {
                    const prompt = module.prompts[promptId];
                    const executions = appState.executions.filter(e => e.moduleId === moduleId && e.promptId === promptId);
                    const hasExecutions = executions.length > 0;

                    promptsHTML += `
                        <div class="prompt-item ${hasExecutions ? 'executed' : ''}">
                            <div class="prompt-header">
                                <div>
                                    <span class="prompt-code">${promptId}</span>
                                    <div class="prompt-title">${prompt.title}</div>
                                </div>
                                <span class="engine-badge engine-${prompt.engine}">${getEngineName(prompt.engine)}</span>
                            </div>
                            ${executions.length > 0 ? renderExecutions(executions, moduleId, promptId) : '<p class="text-muted">Nenhuma execu√ß√£o registrada</p>'}
                        </div>
                    `;
                });

                moduleDiv.innerHTML = `
                    <div class="module-header">
                        <h3 class="module-title">M√≥dulo ${moduleId}: ${module.name}</h3>
                    </div>
                    ${promptsHTML}
                `;

                container.appendChild(moduleDiv);
            });
        }

        function renderExecutions(executions, moduleId, promptId) {
            let html = '<div class="executions-list">';
            
            executions.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((exec, index) => {
                const isPrimary = index === 0; // Mais recente √© marcada como principal
                html += `
                    <div class="execution-item">
                        <div class="execution-header">
                            <span class="execution-date">
                                ${isPrimary ? '‚≠ê ' : ''}${new Date(exec.date).toLocaleString('pt-BR')}
                            </span>
                            <span class="engine-badge engine-${exec.engine}">${getEngineName(exec.engine)}</span>
                        </div>
                        ${exec.notes ? `<p class="text-muted">${exec.notes}</p>` : ''}
                        ${renderLinks(exec.links || [], moduleId, promptId, exec.date)}
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function renderLinks(links, moduleId, promptId, execDate) {
            if (links.length === 0) return '<p class="text-muted">Nenhum link registrado</p>';

            let html = '<div class="links-section">';
            links.forEach((link, linkIndex) => {
                html += `
                    <div class="link-item ${link.status}">
                        <div class="link-url">${link.url}</div>
                        ${link.title ? `<div><strong>${link.title}</strong></div>` : ''}
                        ${link.notes ? `<div class="text-muted">${link.notes}</div>` : ''}
                        <div class="link-controls">
                            <button onclick="updateLinkStatus('${moduleId}', '${promptId}', '${execDate}', ${linkIndex}, 'verified')">‚úì Verificado</button>
                            <button onclick="updateLinkStatus('${moduleId}', '${promptId}', '${execDate}', ${linkIndex}, 'relevant')" class="success">‚òÖ Relevante</button>
                            <button onclick="updateLinkStatus('${moduleId}', '${promptId}', '${execDate}', ${linkIndex}, 'irrelevant')" class="secondary">‚úï Irrelevante</button>
                            <button onclick="editLinkNotes('${moduleId}', '${promptId}', '${execDate}', ${linkIndex})">üìù Anotar</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function getEngineName(engine) {
            const names = {
                'gemini': 'Gemini',
                'perplexity': 'Perplexity',
                'consensus': 'Consensus'
            };
            return names[engine] || engine;
        }

        // ==================== MODAL E FORMUL√ÅRIOS ====================
        
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function populateModuleSelect() {
            const select = document.getElementById('moduleSelect');
            Object.keys(PROMPTS_STRUCTURE).forEach(moduleId => {
                const option = document.createElement('option');
                option.value = moduleId;
                option.textContent = `M√≥dulo ${moduleId}: ${PROMPTS_STRUCTURE[moduleId].name}`;
                select.appendChild(option);
            });
        }

        function updatePromptSelect() {
            const moduleId = document.getElementById('moduleSelect').value;
            const promptSelect = document.getElementById('promptSelect');
            promptSelect.innerHTML = '<option value="">Selecione um prompt...</option>';

            if (moduleId) {
                const prompts = PROMPTS_STRUCTURE[moduleId].prompts;
                Object.keys(prompts).forEach(promptId => {
                    const option = document.createElement('option');
                    option.value = promptId;
                    option.textContent = `${promptId} - ${prompts[promptId].title}`;
                    option.dataset.engine = prompts[promptId].engine;
                    promptSelect.appendChild(option);
                });
            }
        }

        function openAddExecutionModal() {
            openModal('addExecutionModal');
        }

        function addExecution(event) {
            event.preventDefault();

            const moduleId = document.getElementById('moduleSelect').value;
            const promptId = document.getElementById('promptSelect').value;
            const engine = document.getElementById('engineSelect').value;
            const notes = document.getElementById('executionNotes').value;
            const linksText = document.getElementById('linksInput').value;

            const links = linksText.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .map(url => ({
                    url,
                    title: '',
                    status: 'unverified',
                    notes: '',
                    zoteroImported: false
                }));

            const execution = {
                moduleId,
                promptId,
                engine,
                date: new Date().toISOString(),
                notes,
                links
            };

            appState.executions.push(execution);
            saveState();

            closeModal('addExecutionModal');
            event.target.reset();
        }

        function updateLinkStatus(moduleId, promptId, execDate, linkIndex, status) {
            const execution = appState.executions.find(e => 
                e.moduleId === moduleId && 
                e.promptId === promptId && 
                e.date === execDate
            );

            if (execution && execution.links[linkIndex]) {
                execution.links[linkIndex].status = status;
                saveState();
            }
        }

        function editLinkNotes(moduleId, promptId, execDate, linkIndex) {
            const execution = appState.executions.find(e => 
                e.moduleId === moduleId && 
                e.promptId === promptId && 
                e.date === execDate
            );

            if (execution && execution.links[linkIndex]) {
                const link = execution.links[linkIndex];
                const newTitle = prompt('T√≠tulo/descri√ß√£o do link:', link.title);
                const newNotes = prompt('Anota√ß√µes:', link.notes);

                if (newTitle !== null) link.title = newTitle;
                if (newNotes !== null) link.notes = newNotes;

                saveState();
            }
        }

        // ==================== BACKUP ====================
        
        function exportBackup() {
            const dataStr = JSON.stringify(appState, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-pesquisa-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            appState.unsavedChanges = 0;
            document.getElementById('unsavedAlert').classList.remove('show');
            saveState();
        }

        function openImportModal() {
            openModal('importModal');
        }

        function importBackup() {
            const file = document.getElementById('importFile').files[0];
            if (!file) {
                alert('Selecione um arquivo');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    appState = imported;
                    appState.unsavedChanges = 0;
                    saveState();
                    closeModal('importModal');
                    alert('Backup importado com sucesso!');
                } catch (error) {
                    alert('Erro ao importar arquivo: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // ==================== TABS ====================
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // ==================== ZOTERO ====================
        
        function exportBibTeX() {
            const relevantLinks = appState.executions.flatMap(exec => 
                (exec.links || [])
                    .filter(link => link.status === 'relevant')
                    .map(link => ({
                        ...link,
                        moduleId: exec.moduleId,
                        promptId: exec.promptId,
                        engine: exec.engine
                    }))
            );

            if (relevantLinks.length === 0) {
                alert('Nenhum link marcado como relevante');
                return;
            }

            let bibtex = '';
            relevantLinks.forEach((link, index) => {
                const key = `fonte_${link.moduleId}_${link.promptId}_${index + 1}`;
                bibtex += `@misc{${key},\n`;
                bibtex += `  title = {${link.title || 'Sem t√≠tulo'}},\n`;
                bibtex += `  url = {${link.url}},\n`;
                bibtex += `  note = {Encontrado via ${getEngineName(link.engine)} - Prompt ${link.promptId}},\n`;
                bibtex += `  urldate = {${new Date().toISOString().split('T')[0]}}\n`;
                bibtex += `}\n\n`;
            });

            const blob = new Blob([bibtex], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `zotero-export-${new Date().toISOString().split('T')[0]}.bib`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showZoteroChecklist() {
            const relevantLinks = appState.executions.flatMap(exec => 
                (exec.links || [])
                    .filter(link => link.status === 'relevant')
                    .map(link => ({
                        ...link,
                        moduleId: exec.moduleId,
                        promptId: exec.promptId
                    }))
            );

            const container = document.getElementById('zoteroChecklist');
            
            if (relevantLinks.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhum link marcado como relevante</p>';
                return;
            }

            let html = '<h3 style="margin-top: 20px;">Checklist de Importa√ß√£o</h3>';
            html += '<div style="max-height: 400px; overflow-y: auto; margin-top: 15px;">';
            
            relevantLinks.forEach((link, index) => {
                html += `
                    <div style="padding: 10px; border: 1px solid var(--gray-200); margin-bottom: 10px; border-radius: 4px;">
                        <label style="display: flex; align-items: start; cursor: pointer;">
                            <input type="checkbox" ${link.zoteroImported ? 'checked' : ''} 
                                onchange="toggleZoteroImport('${link.moduleId}', '${link.promptId}', '${link.url}')" 
                                style="margin-right: 10px; margin-top: 5px;">
                            <div>
                                <div style="font-weight: 500;">${link.title || 'Sem t√≠tulo'}</div>
                                <div style="font-size: 12px; color: var(--gray-700);">${link.url}</div>
                                <div style="font-size: 12px; color: var(--gray-700); margin-top: 5px;">
                                    <span class="engine-badge engine-${link.engine}">${getEngineName(link.engine)}</span>
                                    Prompt ${link.promptId}
                                </div>
                            </div>
                        </label>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function toggleZoteroImport(moduleId, promptId, url) {
            appState.executions.forEach(exec => {
                if (exec.moduleId === moduleId && exec.promptId === promptId) {
                    exec.links.forEach(link => {
                        if (link.url === url) {
                            link.zoteroImported = !link.zoteroImported;
                        }
                    });
                }
            });
            saveState();
        }

        // ==================== INICIALIZA√á√ÉO ====================
        
        window.onload = init;
    </script>
</body>
</html>